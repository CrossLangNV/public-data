import time
import unittest

from CEFAT4Cities.scripts.utils import clean_newlines


class TestCleanNewlines(unittest.TestCase):
    def setUp(self) -> None:
        self.s_in = '\\r\nWat zijn cookies?\n\\r\nCookies zijn kleine informatiebestanden die automatisch op de harde schijf van je computer worden opgeslagen. Cookies worden onder meer gebrui'
        self.s_expected = "Wat zijn cookies?\nCookies zijn kleine informatiebestanden die automatisch op de harde schijf van je computer worden opgeslagen. Cookies worden onder meer gebrui"

    def test_method(self):
        s_out = clean_newlines(self.s_in)

        self.assertEqual(self.s_expected, s_out)

    def test_method_long(self):
        self.s_in = "\\r\nWat zijn cookies?\n\\r\nCookies zijn kleine informatiebestanden die automatisch op de harde schijf van je computer worden opgeslagen. Cookies worden onder meer gebruikt om het gebruiksgemak van de bezoeker te verhogen: een website wordt sneller geladen of je hoeft je loginnaam of instellingen niet telkens opnieuw in te voeren.\nCookies zijn geen actieve, uitvoerende software en zijn niet schadelijk voor je computer. Sommige cookies zorgen ervoor dat een website grafisch netjes verschijnt, andere dat een webapplicatie correct werkt. Daarnaast worden ze ook ingezet om het surfgedrag van bezoekers in kaart te brengen. Die informatie is nuttig om een website zo goed mogelijk af te stemmen op de wensen en noden van de bezoeker.\nDe cookies worden niet gebruikt om het surfgedrag van de bezoeker op andere websites na te gaan. Je internetbrowser laat toe dat je het gebruik van cookies verhindert, dat je een waarschuwing ontvangt wanneer een cookie geïnstalleerd wordt of dat de cookies na het verlaten van de website van je harde schijf worden verwijderd. Raadpleeg hiervoor de help-functie van je internetbrowser.\n\\r\nSoorten cookies\n\\r\nNoodzakelijke cookies\n\\rDeze cookies zijn onmisbaar om onze website te kunnen bezoeken en om bepaalde onderdelen ervan te kunnen gebruiken.\\r\n\\r\n\\r\\r\n\\r\\r\\r\\r\n|Naam cookie\\r||Vervaltermijn\\r||Doel\\r||Inhoud\\r|\n\\r\\r\n|__RequestVerificationToken\\r||Direct tijdelijk cookie, gewist zodra je je browser verlaat.\\r||Dit is een token tegen vervalsing (voorkomt CSRF-aanval).\\r||Aspnet waarde\\r|\n\\r\\r\n|IcordisAUC\\r||Direct tijdelijk cookie, gewist zodra je je browser verlaat.\\r||Authenticatie op de website\\r||Tekst\\r|\n\\r\\r\n|uac\\r||Direct tijdelijk cookie, gewist zodra je je browser verlaat\\r||Noodzakelijk voor het aanmelden via Single Sign On op deze website\\r||Aspnet waarde\\r|\n\\r\\r\\r\n|asp.net_sessionid\\r||Direct tijdelijk cookie, gewist zodra je je browser verlaat\\r||Gebruikt om een geanonimiseerde gebruikerssessie door de server te onderhouden.\\r||unieke identificatie (guid)\\r|\n\\r\n* cookie naam kan een extra waarde bevatten\n\\r\n\\r\nFunctionele cookies\n\\rDie worden gebruikt om het gebruiksgemak van de bezoeker te verhogen en het websitebezoek aangenamer te maken. Het zijn bijvoorbeeld de cookies die je voorkeur onthouden of bijhouden of je al de vraag kreeg om deel te nemen aan een enquête zodat we je niet telkens opnieuw dezelfde enquête voorleggen.\\r\n\\r\n\\r\\r\n\\r\\r\\r\\r\n|Naam cookie\\r||Vervaltermijn\\r||Doel\\r||Inhoud\\r|\n\\r\\r\n|lastvisitedtheme\\r||Direct tijdelijk cookie, gewist zodra je je browser verlaat\\r||De laatst bezochte themapagina bijhouden om zo het actieve onderdeel van het hoofdmenu te kunnen inkleuren.\\r||thema ID\\r|\n\\r\\r\n|cookie-compliance\\r||365 dagen\\r||Bijhouden toestemming cookies\\r||json data\\r|\n\\r\\r\n|iframe-cookie-consent\\r||Direct tijdelijk cookie, gewist zodra je je browser verlaat\\r||Zo weet de website of je de cookies accepteert of niet voor derde partij cookies (iframe)\\r||Goedkeuring cookies\\r|\n\\r\\r\n|search\\r||Direct tijdelijk cookie, gewist zodra je je browser verlaat\\r||Voor correct loggen niet gevonden zoekresultaten\\r||ID\\r|\n\\r\\r\n|contrastskin-website\\r||1000 dagen\\r||Bijhouden hoog contrast actief op de website\\r||1\\r|\n\\r\\r\n|HideAlert*\\r||Afhankelijk van inhoud popup\\r||Popup verbergen bij volgend bezoek\\r||1\\r|\n\\r\\r\\r\n|LastVistedTheme\\r||www-cookies-lastvistedtheme-expiration\\r||www-cookies-lastvistedtheme-purpose\\r||LastVistedTheme waarde \\r|\n\\r\n\\r\nAnalytische cookies\n\\rWe gebruiken performantiecookies om informatie te verzamelen over het gebruik dat bezoekers maken van onze websites met de bedoeling de inhoud van onze websites te verbeteren, meer aan te passen aan de wensen van de bezoekers en om het gebruiksgemak van onze websites te vergroten.\n\\r\n\\r\\r\n\\r\\r\\r\\r\n|Naam cookie\\r||Vervaltermijn\\r||Doel\\r||Inhoud\\r|\n\\r\\r\n|_ga\\r||Bepaald door Google\\r||Analyse van websitebezoeken\\r||GA waarde\\r|\n\\r\\r\n|_gid\\r||Maximum 2 dagen\\r||Analyse van websitebezoeken\\r||GA waarde\\r|\n\\r\\r\n|_gat\\r||Na 10 minuten\\r||Analyse van websitebezoeken\\r||GA waarde\\r|\n\\r\\r\\r\n|__utm*\\r||Maximum 2 jaar\\r||Google Analytics tracking\\r||GA waarde\\r|\n\\r\n\\r\n* cookie naam kan een extra waarde bevatten\n\\r\n\\r\nGoogle Analytics\n\\rDeze website maakt gebruik van Google Analytics\nom bezoekinformatie te meten en te analyseren, om na te gaan via welke weg je op deze website terechtkwam, om te registreren hoe en hoe vaak de verschillende webpagina’s worden bezocht en om de website beter te kunnen afstemmen op de wensen en noden van de gebruiker. Hiertoe verzamelen we aan de hand van je (geanonimiseerd) IP-adres o.a. internetverkeersgegevens en gegevens over je browsertype en computer. Wij gebruiken deze gegevens niet om je persoonlijk te identificeren. Geen enkele informatie over je persoon zal worden gebruikt, bijgehouden of doorgegeven.\\r\n\\r\nCookies van derden\n\\r\nSommige van onze pagina’s tonen inhoud van externe aanbieders, zoals YouTube.\nOm deze inhoud van derden te bekijken, moet u eerst hun specifieke voorwaarden aanvaarden. Dit omvat ook hun cookiebeleid, waarover wij geen controle hebben.\nAls u deze inhoud niet bekijkt, worden er op uw toestel geen cookies van derden geplaatst.\nExterne aanbieders op deze websites\nDeze website heeft geen controle over deze externe diensten. Aanbieders kunnen hun gebruiksvoorwaarden, het doel en gebruik van cookies enz. te allen tijde wijzigen.\n\\r\nHoe kan je het gebruik van cookies weigeren of beheren?\n\\r\nJe kan de installatie van cookies weigeren via je browserinstellingen. Je kan op elk gewenst moment ook de reeds geïnstalleerde cookies van je computer of mobiele apparaat verwijderen, als volgt:\n\\r\n\\r\nWanneer u cookies uitschakelt, moet je er rekening mee houden dat bepaalde grafische elementen er misschien niet mooi uitzien, of dat je bepaalde toepassingen niet kunt gebruiken.\n\\r\nDo not track\n\\r\nDeze website respecteert de 'Do Not Track' (DNT) functie van uw browser. Als je de 'Do Not Track' functionaliteit via de instellingen van je browser heeft ingeschakeld, dan worden er helemaal geen gebruiksgegevens van je bezoek aan de website opgeslagen.\n\\r\n"
        self.s_expected = "Wat zijn cookies?\nCookies zijn kleine informatiebestanden die automatisch op de harde schijf van je computer worden opgeslagen. Cookies worden onder meer gebruikt om het gebruiksgemak van de bezoeker te verhogen: een website wordt sneller geladen of je hoeft je loginnaam of instellingen niet telkens opnieuw in te voeren.\nCookies zijn geen actieve, uitvoerende software en zijn niet schadelijk voor je computer. Sommige cookies zorgen ervoor dat een website grafisch netjes verschijnt, andere dat een webapplicatie correct werkt. Daarnaast worden ze ook ingezet om het surfgedrag van bezoekers in kaart te brengen. Die informatie is nuttig om een website zo goed mogelijk af te stemmen op de wensen en noden van de bezoeker.\nDe cookies worden niet gebruikt om het surfgedrag van de bezoeker op andere websites na te gaan. Je internetbrowser laat toe dat je het gebruik van cookies verhindert, dat je een waarschuwing ontvangt wanneer een cookie geïnstalleerd wordt of dat de cookies na het verlaten van de website van je harde schijf worden verwijderd. Raadpleeg hiervoor de help-functie van je internetbrowser.\nSoorten cookies\nNoodzakelijke cookies\nDeze cookies zijn onmisbaar om onze website te kunnen bezoeken en om bepaalde onderdelen ervan te kunnen gebruiken.\n|Naam cookie\n||Vervaltermijn\n||Doel\n||Inhoud\n|\n|__RequestVerificationToken\n||Direct tijdelijk cookie, gewist zodra je je browser verlaat.\n||Dit is een token tegen vervalsing (voorkomt CSRF-aanval).\n||Aspnet waarde\n|\n|IcordisAUC\n||Direct tijdelijk cookie, gewist zodra je je browser verlaat.\n||Authenticatie op de website\n||Tekst\n|\n|uac\n||Direct tijdelijk cookie, gewist zodra je je browser verlaat\n||Noodzakelijk voor het aanmelden via Single Sign On op deze website\n||Aspnet waarde\n|\n|asp.net_sessionid\n||Direct tijdelijk cookie, gewist zodra je je browser verlaat\n||Gebruikt om een geanonimiseerde gebruikerssessie door de server te onderhouden.\n||unieke identificatie (guid)\n|\n* cookie naam kan een extra waarde bevatten\nFunctionele cookies\nDie worden gebruikt om het gebruiksgemak van de bezoeker te verhogen en het websitebezoek aangenamer te maken. Het zijn bijvoorbeeld de cookies die je voorkeur onthouden of bijhouden of je al de vraag kreeg om deel te nemen aan een enquête zodat we je niet telkens opnieuw dezelfde enquête voorleggen.\n|Naam cookie\n||Vervaltermijn\n||Doel\n||Inhoud\n|\n|lastvisitedtheme\n||Direct tijdelijk cookie, gewist zodra je je browser verlaat\n||De laatst bezochte themapagina bijhouden om zo het actieve onderdeel van het hoofdmenu te kunnen inkleuren.\n||thema ID\n|\n|cookie-compliance\n||365 dagen\n||Bijhouden toestemming cookies\n||json data\n|\n|iframe-cookie-consent\n||Direct tijdelijk cookie, gewist zodra je je browser verlaat\n||Zo weet de website of je de cookies accepteert of niet voor derde partij cookies (iframe)\n||Goedkeuring cookies\n|\n|search\n||Direct tijdelijk cookie, gewist zodra je je browser verlaat\n||Voor correct loggen niet gevonden zoekresultaten\n||ID\n|\n|contrastskin-website\n||1000 dagen\n||Bijhouden hoog contrast actief op de website\n||1\n|\n|HideAlert*\n||Afhankelijk van inhoud popup\n||Popup verbergen bij volgend bezoek\n||1\n|\n|LastVistedTheme\n||www-cookies-lastvistedtheme-expiration\n||www-cookies-lastvistedtheme-purpose\n||LastVistedTheme waarde\n|\nAnalytische cookies\nWe gebruiken performantiecookies om informatie te verzamelen over het gebruik dat bezoekers maken van onze websites met de bedoeling de inhoud van onze websites te verbeteren, meer aan te passen aan de wensen van de bezoekers en om het gebruiksgemak van onze websites te vergroten.\n|Naam cookie\n||Vervaltermijn\n||Doel\n||Inhoud\n|\n|_ga\n||Bepaald door Google\n||Analyse van websitebezoeken\n||GA waarde\n|\n|_gid\n||Maximum 2 dagen\n||Analyse van websitebezoeken\n||GA waarde\n|\n|_gat\n||Na 10 minuten\n||Analyse van websitebezoeken\n||GA waarde\n|\n|__utm*\n||Maximum 2 jaar\n||Google Analytics tracking\n||GA waarde\n|\n* cookie naam kan een extra waarde bevatten\nGoogle Analytics\nDeze website maakt gebruik van Google Analytics\nom bezoekinformatie te meten en te analyseren, om na te gaan via welke weg je op deze website terechtkwam, om te registreren hoe en hoe vaak de verschillende webpagina’s worden bezocht en om de website beter te kunnen afstemmen op de wensen en noden van de gebruiker. Hiertoe verzamelen we aan de hand van je (geanonimiseerd) IP-adres o.a. internetverkeersgegevens en gegevens over je browsertype en computer. Wij gebruiken deze gegevens niet om je persoonlijk te identificeren. Geen enkele informatie over je persoon zal worden gebruikt, bijgehouden of doorgegeven.\nCookies van derden\nSommige van onze pagina’s tonen inhoud van externe aanbieders, zoals YouTube.\nOm deze inhoud van derden te bekijken, moet u eerst hun specifieke voorwaarden aanvaarden. Dit omvat ook hun cookiebeleid, waarover wij geen controle hebben.\nAls u deze inhoud niet bekijkt, worden er op uw toestel geen cookies van derden geplaatst.\nExterne aanbieders op deze websites\nDeze website heeft geen controle over deze externe diensten. Aanbieders kunnen hun gebruiksvoorwaarden, het doel en gebruik van cookies enz. te allen tijde wijzigen.\nHoe kan je het gebruik van cookies weigeren of beheren?\nJe kan de installatie van cookies weigeren via je browserinstellingen. Je kan op elk gewenst moment ook de reeds geïnstalleerde cookies van je computer of mobiele apparaat verwijderen, als volgt:\nWanneer u cookies uitschakelt, moet je er rekening mee houden dat bepaalde grafische elementen er misschien niet mooi uitzien, of dat je bepaalde toepassingen niet kunt gebruiken.\nDo not track\nDeze website respecteert de 'Do Not Track' (DNT) functie van uw browser. Als je de 'Do Not Track' functionaliteit via de instellingen van je browser heeft ingeschakeld, dan worden er helemaal geen gebruiksgegevens van je bezoek aan de website opgeslagen."

        s_out = clean_newlines(self.s_in)
        self.assertEqual(self.s_expected, s_out)

    def test_equal_old(self):
        s_out = clean_newlines(self.s_in)

        self.assertEqual(self.clean_newlines_old(self.s_in), s_out)

    def test_speed(self):
        n = 10000

        def timeit(method, name):
            t0 = time.time()
            for i in range(n): method(self.s_in)
            t1 = time.time()

            print(f'{name}. T={t1 - t0} s')

        timeit(self.clean_newlines_old, 'Old method')
        timeit(clean_newlines, 'New method')

    @staticmethod
    def clean_newlines_old(s):
        s_clean = s.replace('\\r', '\r').replace('\\R', '\r')
        s_clean = s_clean.replace('\\n', '\n').replace('\\N', '\n')
        # Remove empty lines.
        s_clean = '\n'.join(filter(lambda x: x.replace(' ', ''), s_clean.splitlines()))

        return s_clean
